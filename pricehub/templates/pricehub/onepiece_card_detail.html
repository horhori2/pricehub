{% extends 'pricehub/base.html' %}

{% block title %}{{ card.name }} - ê°€ê²© ì •ë³´{% endblock %}

{% block extra_css %}
<style>
    .period-btn {
        display: inline-block;
        padding: 8px 15px;
        font-size: 0.9em;
        background: #667eea;
        color: white;
        text-decoration: none;
        border-radius: 5px;
        transition: background 0.3s;
    }
    
    .period-btn:hover {
        background: #5568d3;
    }
    
    .period-btn.period-active {
        background: #5568d3;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }
</style>
{% endblock %}

{% block breadcrumb %}
<div class="breadcrumb">
    <a href="{% url 'pricehub:onepiece_expansion_list' %}">ì›í”¼ìŠ¤ í™•ì¥íŒ© ëª©ë¡</a> &gt; 
    <a href="{% url 'pricehub:onepiece_card_list' card.expansion.code %}">{{ card.expansion.name }}</a> &gt; 
    {{ card.name }}
</div>
{% endblock %}

{% block content %}
<!-- ì¹´ë“œ ì •ë³´ ì¹´ë“œ -->
<div class="card">
    <div style="display: grid; grid-template-columns: 250px 1fr; gap: 30px;">
        <div>
            {% if card.image_url %}
            <img src="{{ card.image_url }}" alt="{{ card.name }}" 
                 style="width: 100%; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
            {% else %}
            <div style="width: 100%; height: 350px; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); 
                        border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 5em;">
                ğŸ´â€â˜ ï¸
            </div>
            {% endif %}
        </div>
        
        <div>
            <h2 style="margin-bottom: 10px;">{{ card.name }}</h2>
            <p style="color: #666; margin-bottom: 5px;">í™•ì¥íŒ©: {{ card.expansion.name }} ({{ card.expansion.code }})</p>
            <p style="color: #666; margin-bottom: 5px;">ì¹´ë“œë²ˆí˜¸: {{ card.card_number }}</p>
            <p style="color: #666; margin-bottom: 20px;">ë ˆì–´ë„: {{ card.rarity }}</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <h3 style="font-size: 1em; color: #666; margin-bottom: 10px;">ğŸ’° ì¼ë°˜ ìµœì €ê°€</h3>
                    {% if latest_general %}
                    <p style="font-size: 2em; font-weight: bold; color: #333;">{{ latest_general.price|floatformat:0 }}ì›</p>
                    <p style="font-size: 0.9em; color: #999; margin-top: 5px;">{{ latest_general.source }}</p>
                    <p style="font-size: 0.8em; color: #999;">{{ latest_general.collected_at|date:"Y-m-d H:i" }}</p>
                    {% else %}
                    <p style="font-size: 1.2em; color: #999;">ê°€ê²© ì •ë³´ ì—†ìŒ</p>
                    {% endif %}
                </div>
                
                <div style="background: #f0f4ff; padding: 20px; border-radius: 8px;">
                    <h3 style="font-size: 1em; color: #667eea; margin-bottom: 10px;">ğŸ¯ TCG999 ê°€ê²©</h3>
                    {% if latest_tcg999 %}
                    <p style="font-size: 2em; font-weight: bold; color: #667eea;">{{ latest_tcg999.price|floatformat:0 }}ì›</p>
                    <p style="font-size: 0.9em; color: #999; margin-top: 5px;">{{ latest_tcg999.store_name }}</p>
                    <p style="font-size: 0.8em; color: #999;">{{ latest_tcg999.collected_at|date:"Y-m-d H:i" }}</p>
                    {% else %}
                    <p style="font-size: 1.2em; color: #999;">ê°€ê²© ì •ë³´ ì—†ìŒ</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ê°€ê²© í†µê³„ -->
<div class="card" style="margin-top: 20px;">
    <h3 style="margin-bottom: 20px;">ğŸ“Š ê°€ê²© í†µê³„</h3>
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
        <!-- ì¼ë°˜ ìµœì €ê°€ í†µê³„ -->
        <div>
            <h4 style="font-size: 0.9em; color: #666; margin-bottom: 15px;">ğŸ’° ì¼ë°˜ ìµœì €ê°€</h4>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; text-align: center;">
                    <p style="font-size: 0.8em; color: #999; margin-bottom: 5px;">ìµœì €</p>
                    <p style="font-size: 1.3em; font-weight: bold; color: #28a745;">
                        {% if stats.general.min %}{{ stats.general.min|floatformat:0 }}ì›{% else %}-{% endif %}
                    </p>
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; text-align: center;">
                    <p style="font-size: 0.8em; color: #999; margin-bottom: 5px;">í‰ê· </p>
                    <p style="font-size: 1.3em; font-weight: bold; color: #333;">
                        {% if stats.general.avg %}{{ stats.general.avg|floatformat:0 }}ì›{% else %}-{% endif %}
                    </p>
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; text-align: center;">
                    <p style="font-size: 0.8em; color: #999; margin-bottom: 5px;">ìµœê³ </p>
                    <p style="font-size: 1.3em; font-weight: bold; color: #dc3545;">
                        {% if stats.general.max %}{{ stats.general.max|floatformat:0 }}ì›{% else %}-{% endif %}
                    </p>
                </div>
            </div>
        </div>
        
        <!-- TCG999 í†µê³„ -->
        <div>
            <h4 style="font-size: 0.9em; color: #667eea; margin-bottom: 15px;">ğŸ¯ TCG999</h4>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                <div style="background: #f0f4ff; padding: 15px; border-radius: 5px; text-align: center;">
                    <p style="font-size: 0.8em; color: #999; margin-bottom: 5px;">ìµœì €</p>
                    <p style="font-size: 1.3em; font-weight: bold; color: #28a745;">
                        {% if stats.tcg999.min %}{{ stats.tcg999.min|floatformat:0 }}ì›{% else %}-{% endif %}
                    </p>
                </div>
                <div style="background: #f0f4ff; padding: 15px; border-radius: 5px; text-align: center;">
                    <p style="font-size: 0.8em; color: #999; margin-bottom: 5px;">í‰ê· </p>
                    <p style="font-size: 1.3em; font-weight: bold; color: #667eea;">
                        {% if stats.tcg999.avg %}{{ stats.tcg999.avg|floatformat:0 }}ì›{% else %}-{% endif %}
                    </p>
                </div>
                <div style="background: #f0f4ff; padding: 15px; border-radius: 5px; text-align: center;">
                    <p style="font-size: 0.8em; color: #999; margin-bottom: 5px;">ìµœê³ </p>
                    <p style="font-size: 1.3em; font-weight: bold; color: #dc3545;">
                        {% if stats.tcg999.max %}{{ stats.tcg999.max|floatformat:0 }}ì›{% else %}-{% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ê°€ê²© ì¶”ì´ ê·¸ë˜í”„ -->
<div class="card" style="margin-top: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3>ğŸ“ˆ ê°€ê²© ì¶”ì´</h3>
        
        <!-- ê¸°ê°„ ì„ íƒ ë²„íŠ¼ -->
        <div style="display: flex; gap: 10px;">
            <a href="?period=7" class="period-btn {% if period == '7' %}period-active{% endif %}">
                1ì£¼ì¼
            </a>
            <a href="?period=30" class="period-btn {% if period == '30' or not period %}period-active{% endif %}">
                1ê°œì›”
            </a>
            <a href="?period=90" class="period-btn {% if period == '90' %}period-active{% endif %}">
                3ê°œì›”
            </a>
            <a href="?period=all" class="period-btn {% if period == 'all' %}period-active{% endif %}">
                ì „ì²´
            </a>
        </div>
    </div>
    <canvas id="priceChart" style="max-height: 400px;"></canvas>
</div>

<!-- ì°¨íŠ¸ ë°ì´í„°ë¥¼ JSONìœ¼ë¡œ ì „ë‹¬ -->
<script id="chart-data" type="application/json">
    {
        "general": {
            "labels": {{ general_chart_data.labels|safe }},
            "data": {{ general_chart_data.data|safe }}
        },
        "tcg999": {
            "labels": {{ tcg999_chart_data.labels|safe }},
            "data": {{ tcg999_chart_data.data|safe }}
        }
    }
</script>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // JSON ë°ì´í„° íŒŒì‹±
    const chartDataElement = document.getElementById('chart-data');
    const chartData = JSON.parse(chartDataElement.textContent);
    
    const generalLabels = chartData.general.labels;
    const generalData = chartData.general.data;
    const tcg999Labels = chartData.tcg999.labels;
    const tcg999Data = chartData.tcg999.data;
    
    // ëª¨ë“  ë‚ ì§œ í•©ì¹˜ê¸°
    const allLabels = [...new Set([...generalLabels, ...tcg999Labels])].sort();
    
    // ì°¨íŠ¸ ìƒì„±
    const ctx = document.getElementById('priceChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: allLabels,
            datasets: [
                {
                    label: 'ì¼ë°˜ ìµœì €ê°€',
                    data: generalData,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 3,
                    pointHoverRadius: 6
                },
                {
                    label: 'TCG999',
                    data: tcg999Data,
                    borderColor: '#f093fb',
                    backgroundColor: 'rgba(240, 147, 251, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 3,
                    pointHoverRadius: 6
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        font: {
                            size: 14
                        },
                        usePointStyle: true,
                        padding: 15
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: {
                        size: 14
                    },
                    bodyFont: {
                        size: 13
                    },
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + 'ì›';
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    }
                },
                y: {
                    beginAtZero: false,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString() + 'ì›';
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}