{% extends 'pricehub/base.html' %}

{% block title %}{{ expansion.name }} - ì¹´ë“œ ëª©ë¡{% endblock %}

{% block extra_css %}
<style>
    .sort-select {
        padding: 10px 15px;
        border: 2px solid #667eea;
        border-radius: 5px;
        font-size: 0.95em;
        outline: none;
        cursor: pointer;
        background: white;
        color: #333;
    }
    
    .sort-select:focus {
        border-color: #5568d3;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .sortable-header {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 25px !important;
        transition: background 0.2s;
    }
    
    .sortable-header:hover {
        background: rgba(255, 255, 255, 0.1);
    }
    
    .sortable-header::after {
        content: 'â†•';
        position: absolute;
        right: 10px;
        opacity: 0.5;
        font-size: 0.9em;
    }
    
    .sortable-header.active-asc::after {
        content: 'â†‘';
        opacity: 1;
        font-weight: bold;
    }
    
    .sortable-header.active-desc::after {
        content: 'â†“';
        opacity: 1;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block breadcrumb %}
<div class="breadcrumb">
    <a href="{% url 'pricehub:onepiece_expansion_list' %}">ì›í”¼ìŠ¤ í™•ì¥íŒ© ëª©ë¡</a> &gt; {{ expansion.name }}
</div>
{% endblock %}

{% block content %}
<div style="margin-bottom: 30px;">
    <h2>{{ expansion.name }} ({{ expansion.code }})</h2>
    <p style="color: #666; margin-top: 10px;">ì´ {{ total_count }}ì¥</p>
    
    <!-- ê²€ìƒ‰ë°” ë° ì •ë ¬ ì˜µì…˜ -->
    <div style="margin-top: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
        <!-- ê²€ìƒ‰ë°” -->
        <form method="get" style="display: flex; gap: 10px; flex: 1; min-width: 300px;">
            <input type="text" 
                   name="q" 
                   style="flex: 1; padding: 10px 15px; border: 2px solid #667eea; border-radius: 5px; font-size: 1em; outline: none;"
                   placeholder="ì´ í™•ì¥íŒ©ì—ì„œ ê²€ìƒ‰..."
                   value="{{ query }}"
                   autocomplete="off">
            <input type="hidden" name="sort" value="{{ sort_by }}">
            <button type="submit" 
                    style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
                ğŸ” ê²€ìƒ‰
            </button>
            {% if query %}
            <a href="?sort={{ sort_by }}" 
               style="padding: 10px 20px; background: #999; color: white; border-radius: 5px; text-decoration: none; display: flex; align-items: center;">
                âœ•
            </a>
            {% endif %}
        </form>
        
        <!-- ì •ë ¬ ì˜µì…˜ -->
        <div style="display: flex; gap: 10px; align-items: center;">
            <label style="font-weight: 500; color: #666;">ì •ë ¬:</label>
            <select class="sort-select" onchange="location.href=this.value">
                <option value="?q={{ query }}&sort=number" {% if sort_by == 'number' %}selected{% endif %}>
                    ğŸ“‹ ì¹´ë“œë²ˆí˜¸ìˆœ
                </option>
                <option value="?q={{ query }}&sort=name" {% if sort_by == 'name' %}selected{% endif %}>
                    ğŸ”¤ ì¹´ë“œëª…ìˆœ
                </option>
                <option value="?q={{ query }}&sort=rarity" {% if sort_by == 'rarity' %}selected{% endif %}>
                    â­ ë ˆì–´ë„ìˆœ
                </option>
                <option value="?q={{ query }}&sort=general_high" {% if sort_by == 'general_high' %}selected{% endif %}>
                    ğŸ’° ìµœì €ê°€ ë†’ì€ìˆœ
                </option>
                <option value="?q={{ query }}&sort=general_low" {% if sort_by == 'general_low' %}selected{% endif %}>
                    ğŸ’¸ ìµœì €ê°€ ë‚®ì€ìˆœ
                </option>
                <option value="?q={{ query }}&sort=tcg999_high" {% if sort_by == 'tcg999_high' %}selected{% endif %}>
                    ğŸ¯ TCG999 ë†’ì€ìˆœ
                </option>
                <option value="?q={{ query }}&sort=tcg999_low" {% if sort_by == 'tcg999_low' %}selected{% endif %}>
                    ğŸ¯ TCG999 ë‚®ì€ìˆœ
                </option>
            </select>
        </div>
    </div>
    
    {% if query %}
    <p style="margin-top: 15px; color: #667eea; font-weight: 500;">
        "{{ query }}" ê²€ìƒ‰ ê²°ê³¼: {{ cards.count }}ê°œ
    </p>
    {% endif %}
    
    <p style="margin-top: 10px; font-size: 0.9em; color: #999;">
        ğŸ’¡ í…Œì´ë¸” í—¤ë”ë¥¼ í´ë¦­í•˜ì—¬ ì •ë ¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
    </p>
</div>

<div style="overflow-x: auto;">
    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
        <thead style="background: #667eea; color: white;">
            <tr>
                <th class="sortable-header {% if sort_by == 'number' %}active-asc{% endif %}" 
                    onclick="location.href='?q={{ query }}&sort=number'"
                    style="padding: 15px; text-align: left;">
                    ì¹´ë“œë²ˆí˜¸
                </th>
                <th style="padding: 15px; text-align: left;">ì´ë¯¸ì§€</th>
                <th class="sortable-header {% if sort_by == 'name' %}active-asc{% endif %}" 
                    onclick="location.href='?q={{ query }}&sort=name'"
                    style="padding: 15px; text-align: left;">
                    ì¹´ë“œëª…
                </th>
                <th class="sortable-header {% if sort_by == 'rarity' %}active-asc{% endif %}" 
                    onclick="location.href='?q={{ query }}&sort=rarity'"
                    style="padding: 15px; text-align: center;">
                    ë ˆì–´ë„
                </th>
                <th class="sortable-header {% if sort_by == 'general_low' %}active-asc{% elif sort_by == 'general_high' %}active-desc{% endif %}" 
                    onclick="toggleSort('general', '{{ query }}', '{{ sort_by }}')"
                    style="padding: 15px; text-align: right;">
                    ì¼ë°˜ ìµœì €ê°€
                </th>
                <th class="sortable-header {% if sort_by == 'tcg999_low' %}active-asc{% elif sort_by == 'tcg999_high' %}active-desc{% endif %}" 
                    onclick="toggleSort('tcg999', '{{ query }}', '{{ sort_by }}')"
                    style="padding: 15px; text-align: right;">
                    TCG999
                </th>
                <th style="padding: 15px; text-align: center;">ìƒì„¸</th>
            </tr>
        </thead>
        <tbody>
            {% for card in cards %}
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 15px;">{{ card.card_number }}</td>
                <td style="padding: 15px;">
                    {% if card.image_url %}
                    <img src="{{ card.image_url }}" alt="{{ card.name }}" 
                         style="width: 60px; height: 80px; object-fit: cover; border-radius: 5px;">
                    {% else %}
                    <div style="width: 60px; height: 80px; background: #f0f0f0; border-radius: 5px; display: flex; align-items: center; justify-content: center;">
                        ğŸ´â€â˜ ï¸
                    </div>
                    {% endif %}
                </td>
                <td style="padding: 15px; font-weight: 500;">{{ card.name }}</td>
                <td style="padding: 15px; text-align: center;">
                    <span style="background: #f0f0f0; padding: 5px 10px; border-radius: 3px; font-size: 0.9em;">
                        {{ card.rarity }}
                    </span>
                </td>
                <td style="padding: 15px; text-align: right; font-weight: 500;">
                    {% if card.latest_general_price %}
                        {{ card.latest_general_price|floatformat:0 }}ì›
                        <br><span style="font-size: 0.8em; color: #999;">{{ card.latest_general_source }}</span>
                    {% else %}
                        <span style="color: #999;">-</span>
                    {% endif %}
                </td>
                <td style="padding: 15px; text-align: right; font-weight: 500; color: #667eea;">
                    {% if card.latest_tcg999_price %}
                        {{ card.latest_tcg999_price|floatformat:0 }}ì›
                    {% else %}
                        <span style="color: #999;">-</span>
                    {% endif %}
                </td>
                <td style="padding: 15px; text-align: center;">
                    <a href="{% url 'pricehub:onepiece_card_detail' card.id %}" class="btn" style="padding: 5px 15px; font-size: 0.9em;">
                        ğŸ“Š ì°¨íŠ¸
                    </a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" style="padding: 50px; text-align: center; color: #999;">
                    {% if query %}
                        "{{ query }}"ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
                    {% else %}
                        ë“±ë¡ëœ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    function toggleSort(type, query, currentSort) {
        let newSort;
        
        if (type === 'general') {
            if (currentSort === 'general_low') {
                newSort = 'general_high';
            } else {
                newSort = 'general_low';
            }
        } else if (type === 'tcg999') {
            if (currentSort === 'tcg999_low') {
                newSort = 'tcg999_high';
            } else {
                newSort = 'tcg999_low';
            }
        }
        
        location.href = '?q=' + query + '&sort=' + newSort;
    }
</script>
{% endblock %}